# Story 1.3: Visitor Email Notification

## Story Metadata

**Story ID:** 1.3
**Title:** Visitor Email Notification
**Epic:** Epic 1 - Privacy & Visitor Experience
**Status:** Done
**Priority:** High
**Story Points:** 2
**Sprint:** Sprint 1

## User Story

As a portfolio owner, I want to receive an email notification whenever someone visits my portfolio site, so that I can track visitor activity and engagement.

## Business Value

- **Primary:** Real-time awareness of portfolio traffic
- **Secondary:** Visitor engagement insights without analytics tools
- **Privacy:** No user consent required as no PII is collected

## Product Requirements

### Email Content

The body of the email notification must be clearly formatted as follows:

```text
New Visitor Alert!

- Timestamp: [YYYY-MM-DD HH:MM:SS UTC]
- Geolocation: [City, Region, Country]
- IP Address: [Visitor's IP]
- User Agent: [Visitor's User Agent String]
```

## Acceptance Criteria

### Functional Requirements

- [x] **AC1:** An email notification is sent upon the first visit in a session.
- [x] **AC2:** The email subject line is `*ALERT - PROFILE SITE VISITED`.
- [x] **AC3:** The email body contains the visitor's IP-based geolocation (City, Region, Country), timestamp, IP address, and user-agent string.
- [x] **AC4:** Subsequent page loads or refreshes from the same IP address within a 5-minute window do not trigger a new email.
- [x] **AC5:** The feature does not display a user consent prompt.
- [x] **AC6:** Failure to send the email does not impact the user's experience.

### Technical Requirements

- [x] **AC7:** The implementation must use the existing EmailJS service configuration.
- [x] **AC8:** A new `VisitorTracker` component will encapsulate the tracking logic.
- [x] **AC9:** IP geolocation is implemented via an external API call.
- [x] **AC10:** All API calls for tracking are asynchronous and do not block UI rendering.
- [x] **AC11:** Errors during data collection or email sending are logged to the console for debugging.

### Security & Privacy Requirements

- [x] **AC12:** No Personally Identifiable Information (PII) is stored or logged by our application.
- [x] **AC13:** The solution adheres to GDPR/CCPA principles for visitor data handling.
- [x] **AC14:** The public key for the EmailJS service is used for authentication.
- [x] **AC15:** No sensitive data is exposed in the browser console.

## Technical Specifications

### Architecture Overview

The feature will be implemented via a new `<VisitorTracker />` component, initiated from `App.tsx`. This component will use a custom hook, `useVisitorTracker`, to orchestrate data fetching and email dispatch.

### Component & Service Structure

```
src/
├── components/
│   └── VisitorTracker.tsx      # New: Manages tracking logic lifecycle.
├── services/
│   ├── emailService.ts         # Existing: To be used for sending notifications.
│   └── ipGeolocationService.ts # New: Fetches visitor location data.
├── hooks/
│   └── useVisitorTracker.ts    # New: Orchestrates data fetching and email sending.
└── types/
    └── visitor.types.ts        # New: Defines the Visitor data structure.
```

### API Integrations

1.  **EmailJS Service**

    - **Purpose:** Send notification email.
    - **Details:** Use existing `emailService.ts`.
    - **Template ID:** A new template `template_visitor_notification` will be required.

2.  **IP Geolocation Service**
    - **Recommended Service:** `ipapi.co` (free tier available).
    - **Endpoint:** `GET https://ipapi.co/json/`
    - **Fallback:** If the API call fails, the email should be sent with "N/A" for geolocation fields.

### Data Flow

1.  `App.tsx` mounts the `<VisitorTracker />` component.
2.  `useVisitorTracker` hook is triggered on mount.
3.  The hook checks if a notification has been sent for the current IP in the last 5 minutes (using `sessionStorage` or a similar client-side mechanism).
4.  If no recent notification, `ipGeolocationService` is called.
5.  Once data is collected, `emailService` is called to send the notification.
6.  On success, a timestamp is stored to prevent re-triggering.

### Error Handling

- All external API calls must have `.catch` blocks.
- Failures should be logged to the console and should not interrupt the user experience.
- If the geolocation service fails, the email should still be sent with available data.

## Implementation Tasks

### Backend Setup (EmailJS)

- [x] **Task 1:** Create a new email template in the EmailJS dashboard named `template_visitor_notification`.
- [x] **Task 2:** Configure the template to accept parameters for timestamp, geolocation, IP, and user agent.

### Frontend Development

- [x] **Task 3:** Create `visitor.types.ts` to define the data structure for visitor information.
- [x] **Task 4:** Implement `ipGeolocationService.ts` to fetch data from `ipapi.co`.
- [x] **Task 5:** Implement the `useVisitorTracker` custom hook with the 5-minute rate-limiting logic.
- [x] **Task 6:** Create the `<VisitorTracker />` component that uses the hook.
- [x] **Task 7:** Integrate `<VisitorTracker />` into `App.tsx`.

### Testing

- [x] **Task 8:** Write unit tests for the `useVisitorTracker` hook, including the rate-limiting logic.
- [x] **Task 9:** Write unit tests for `ipGeolocationService`.
- [x] **Task 10:** Perform manual end-to-end testing to verify email content and formatting.
- [x] **Task 11:** Test the rate-limiting feature by refreshing the page multiple times.

## Dependencies

### External Services

- **EmailJS:** For email delivery.
- **ipapi.co:** For IP geolocation (or a similar service).

### Internal Dependencies

- This story has no direct dependencies on other user stories. It relies on the existing EmailJS configuration.

## Risks & Mitigations

| Risk                                     | Impact | Probability | Mitigation                                                                                                                              |
| ---------------------------------------- | ------ | ----------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| Geolocation API is unreliable or changes | Low    | Medium      | The code should handle failures gracefully, sending the email with "N/A" for location data.                                             |
| EmailJS service has an outage            | Medium | Low         | The application should not crash. Errors should be logged to the console.                                                               |
| Inaccurate geolocation data              | Low    | High        | This is an inherent limitation of IP-based geolocation. The value is in the trend, not the exact location. Acknowledge this limitation. |

## Definition of Done

- [x] All Acceptance Criteria (AC1-AC15) are met.
- [x] Code has been peer-reviewed and approved.
- [x] Unit tests for new services and hooks achieve >90% coverage.
- [x] The feature has been manually tested and verified as working per the ACs.
- [x] The notification email is correctly formatted and delivered.
- [x] The rate-limiting functionality is confirmed to work as expected.

## Story Checklist

- [x] Story has been refined by the Product Owner.
- [x] Acceptance criteria are clear and testable.
- [x] Technical approach has been outlined.
- [x] Dependencies and risks are identified.
- [x] Story is estimated and ready for sprint planning.
